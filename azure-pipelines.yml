trigger:
  branches:
    include:
      - "*"

pr:
  branches:
    include:
      - "*"

variables:
  SCRIPTS: 'scripts'   # your folder that has init.sh, plan.sh, apply.sh
  ENV: 'dev'

stages:
  - stage: ValidateAndPlan
    displayName: "Terraform Validate & Plan"
    jobs:
    - job: ValidateAndPlan
      displayName: Validate and Plan
      pool:
        name: Default
        demands: agent.name -equals Udeeks-MacBook-Air-2
      steps:
        - checkout: self
        - script: |
            chmod +x $(SCRIPTS)/init.sh
            chmod +x $(SCRIPTS)/plan.sh
            $(SCRIPTS)/init.sh $(ENV)
            terraform validate
            $(SCRIPTS)/plan.sh $(ENV) > plan-output.txt
          displayName: Run Init, Validate, and Plan
        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: 'plan-output.txt'
            ArtifactName: 'tfplan'
            publishLocation: 'Container'



# Optional future stage:
#   - stage: Apply
#     displayName: "Terraform Apply"
#     dependsOn: ValidateAndPlan
#     condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'main'))
#     jobs:
#       - job: Apply
#         displayName: "Terraform Apply"
#         pool:
#           name: Default
#           demands: agent.name -equals Udeeks-MacBook-Air-2
#         steps:
#           - checkout: self
#           - script: |
#               chmod +x $(SCRIPTS)/apply.sh
#               $(SCRIPTS)/apply.sh $(ENV)
#             displayName: "Run Terraform Apply"
